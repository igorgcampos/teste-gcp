options:
  logging: GCS_ONLY
  defaultLogsBucketBehavior: REGIONAL_USER_OWNED_BUCKET

steps:

  # Passo 1: Instalar a Google Cloud CLI
  - name: 'Install Google Cloud CLI'
    image: 'gcr.io/cloudbuilders/google-cloud-sdk'

  # Passo 2: Acessar o Secret Manager
  - name: 'Access Secret Manager - DB_USER'
    command: ['bash', '-c', 'gcloud secrets access-secret-version --secret=DB_USER --version=1 --format=json | jq -r .value']
    env:
      - name: 'DB_USER'
        value: '$(echo $0)'

  - name: 'Access Secret Manager - DB_PASS'
    command: ['bash', '-c', 'gcloud secrets access-secret-version --secret=DB_PASS --version=3 --format=json | jq -r .value']
    env:
      - name: 'DB_PASS'
        value: '$(echo $0)'

  - name: 'Access Secret Manager - DB_NAME'
    command: ['bash', '-c', 'gcloud secrets access-secret-version --secret=DB_NAME --version=1 --format=json | jq -r .value']
    env:
      - name: 'DB_NAME'
        value: '$(echo $0)'

  # Passo 3: Construir a imagem Docker
  - name: 'Build Docker Image'
    image: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/sua-imagem:$SHORT_SHA', '.']

  # Passo 4: Enviar a imagem para o Container Registry
  - name: 'Push Docker Image'
    image: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/sua-imagem:$SHORT_SHA']

  # Passo 5: Criar o Cloud Run Job
  - name: 'Create Cloud Run Job'
    image: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args:
      - 'beta'
      - 'run'
      - 'jobs'
      - 'create'
      - 'infograficos' # Substitua pelo nome desejado para o seu job
      '--image'
      - 'gcr.io/$PROJECT_ID/sua-imagem:$SHORT_SHA'
      '--region'
      - 'us-east4'
      '--set-cloudsql-instances'
      - 'infograficos-prd:us-east4:infograficos'
      '--vpc-connector'
      - 'cloudrun-cloudsql' # Nome do VPC Connector
      '--set-env-vars'
      - 'DB_USER=$(DB_USER),DB_PASS=$(DB_PASS),DB_NAME=$(DB_NAME),INSTANCE_CONNECTION_NAME=infograficos-prd:us-east4:infograficos'
      '--max-retries'
      - '0'
    id: 'create-job'

  # Passo 6 (Opcional): Executar o Job imediatamente após a criação
  - name: 'Execute Cloud Run Job (Optional)'
    image: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args:
      - 'beta'
      - 'run'
      - 'jobs'
      - 'execute'
      - 'infograficos' # Deve corresponder ao nome do job criado na etapa anterior
      '--region'
      - 'us-east4'
    id: 'execute-job'
    waitFor: 'create-job'
    images: 'gcr.io/$PROJECT_ID/sua-imagem:$SHORT_SHA'
