options:
  logging: GCS_ONLY
  defaultLogsBucketBehavior: REGIONAL_USER_OWNED_BUCKET
   
steps:

# Download Secret Values (New Step)
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    DB_USER=$(gcloud secrets versions access latest --secret="DB_USER" --project="infograficos-prd")
    DB_PASS=$(gcloud secrets versions access latest --secret="DB_PASS" --project="infograficos-prd")
    DB_NAME=$(gcloud secrets versions access latest --secret="DB_NAME" --project="infograficos-prd")
    echo "DB_USER=$DB_USER" >> $GITHUB_ENV
    echo "DB_PASS=$DB_PASS" >> $GITHUB_ENV
    echo "DB_NAME=$DB_NAME" >> $GITHUB_ENV
  id: 'setup-secrets' # Adicionado um ID para este passo

# Passo 1: Build docker image
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/sua-imagem:$SHORT_SHA', '.']
  waitFor: ['setup-secrets'] # Espera a conclusão do passo anterior

# Passo 2: Send to container registry
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'gcr.io/$PROJECT_ID/sua-imagem:$SHORT_SHA']
  waitFor: ['-'] # Não precisa esperar passos anteriores

# Passo 3: Create cloud run job
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: 'gcloud'
  args:
    - 'beta'
    - 'run'
    - 'jobs'
    - 'create'
    - 'infograficos' # Nome do job
    - '--image'
    - 'gcr.io/$PROJECT_ID/sua-imagem:$SHORT_SHA'
    - '--region'
    - 'us-east4'
    - '--set-cloudsql-instances'
    - 'infograficos-prd:us-east4:infograficos'
    - '--vpc-connector'
    - 'cloudrun-cloudsql' # Nome do VPC Connector
    - '--set-env-vars'
    - 'DB_USER=$$DB_USER,DB_PASS=$$DB_PASS,DB_NAME=$$DB_NAME,INSTANCE_CONNECTION_NAME=infograficos-prd:us-east4:infograficos'
    - '--max-retries'
    - '0'
  id: 'create-job'
  secretEnv: ['DB_USER', 'DB_PASS', 'DB_NAME']
  waitFor: ['-'] # Não precisa esperar passos anteriores

# Passo 4: Run job
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: 'gcloud'
  args:
    - 'beta'
    - 'run'
    - 'jobs'
    - 'execute'
    - 'infograficos'
    - '--region'
    - 'us-east4'
  id: 'execute-job'
  waitFor:
    - 'create-job' # Espera a criação do job

images:
  - 'gcr.io/$PROJECT_ID/sua-imagem:$SHORT_SHA'
  
availableSecrets:
  secretManager:
    - versionName: projects/infograficos-prd/secrets/DB_USER/versions/latest
      env: 'DB_USER'
    - versionName: projects/infograficos-prd/secrets/DB_PASS/versions/latest
      env: 'DB_PASS'
    - versionName: projects/infograficos-prd/secrets/DB_NAME/versions/latest
      env: 'DB_NAME'
