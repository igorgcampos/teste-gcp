options:
  logging: GCS_ONLY
  defaultLogsBucketBehavior: REGIONAL_USER_OWNED_BUCKET
steps:
  # Passo 1: Construir a imagem Docker
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/sua-imagem:$SHORT_SHA', '.']
    
  # Passo 2: Enviar a imagem para o Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/sua-imagem:$SHORT_SHA']

  # Passo 3: Fazer o deploy da imagem no Cloud Run
  - name: 'gcr.io/cloud-builders/gcloud'
    args: ['run', 'deploy', 'teste-gcp',
           '--image', 'gcr.io/$PROJECT_ID/sua-imagem:$SHORT_SHA',
           '--region', 'us-east4',
           '--platform', 'managed',
           '--allow-unauthenticated']
           #--set-env-vars, 'PORT=8080, DB_USER=usuario, DB_PASS=senha, INSTANCE_CONNECTION_NAME=project:region:instance'

# Especificar quais imagens devem ser armazenadas após o build
images:
  - 'gcr.io/$PROJECT_ID/sua-imagem:$SHORT_SHA'

#options:
#  logging: GCS_ONLY
#  defaultLogsBucketBehavior: REGIONAL_USER_OWNED_BUCKET
#steps:
  # Passo 1: Constroi a imagem Docker
#  - name: 'gcr.io/cloud-builders/docker'
#    args: ['build', '-t', 'gcr.io/$PROJECT_ID/sua-imagem:$SHORT_SHA', '.']
    
  # Passo 2: Envia a imagem para o Container Registry
#  - name: 'gcr.io/cloud-builders/docker'
#    args: ['push', 'gcr.io/$PROJECT_ID/sua-imagem:$SHORT_SHA']

  # Passo 3: Faz o deploy da imagem no Cloud Run com o Secret Manager para acessar o CloudSQL
 # - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
 #   entrypoint: 'gcloud'
 #   args:
 #     - 'run'
 #     - 'deploy'
 #     - 'teste-gcp'
 #     - '--image'
 #     - 'gcr.io/$PROJECT_ID/sua-imagem:$SHORT_SHA'
 #     - '--add-cloudsql-instances'
 #     - 'INSTANCE_CONNECTION_NAME' # Substitua pelo nome da sua instância do Cloud SQL
 #     - '--set-env-vars'
 #     - 'DB_USER=projects/$PROJECT_ID/secrets/DB_USER/versions/latest,DB_PASS=projects/$PROJECT_ID/secrets/DB_PASS/versions/latest,INSTANCE_CONNECTION_NAME=project:region:instance,PORT=8080'
 #     - '--region'
 #     - 'us-east4'
 #     - '--platform'
 #     - 'managed'
 #     - '--allow-unauthenticated' # Considerar remover para produção ou ajustar as permissões conforme necessário
 #   timeout: '900s' # Ajuste conforme necessário

# Especificar quais imagens devem ser armazenadas após o build
#images:
#  - 'gcr.io/$PROJECT_ID/sua-imagem:$SHORT_SHA'
